# Ocean Lotus Detection

Featured in "Dropping Lotus Bombs: ATT&CK in macOS Purple Team Operations" #OBTSv6

## Executables in user directories loading modules into memory

Ocean Lotus uses different modules to load different functions. Loading those modules generates `ES_EVENT_TYPE_NOTIFY_MMAP` Endpoint Security Framework (ESF) events. In the Ocean Lotus emulation, the executable was dropped into `~/Library/Webkit/com.apple.launchpad`.

Loading modules is typically done by applications, and most applications don't live in `~/Library/`.

### Detect using ES_EVENT_TYPE_NOTIFY_MMAP events

Look for `ES_EVENT_TYPE_NOTIFY_MMAP` events generated by executables living in user home directories. This will be noisy without some filtering. There are some legitimate applications that put executables in the `~/Library/`

## Unsigned LaunchAgents/LaunchDaemons

OceanLotus persists using a LaunchAgent that runs an unsigned executable.

### Detect using osquery launchd and signature tables

You can write a SQL query that will join the `launchd` and `signature` tables on the `program` or `program_arguments` fields. One caveat - this method fails when the `program` or `program_arguments` field contains an executable with command-line arguments. In those cases, the join on the signature table will fail.

A more sophisticated version where you use the launchd table to pull executable names and then python to parse out all the executables, then check the signing status using osquery.

### Detect by looking for misleading bundle identifiers

In this emulation, Ocean Lotus' LaunchAgent had a bundle id of `com.apple.launchpad` but the executable run in the LaunchAgent was not signed by apple.

We can use the launchd and signature tables in osquery to find these cases. False negatives here are a possibility if the `program_argument` field doesn't match a filename in the `signature` table. In those cases, the join on the signature table will fail.

```
# Osquery SQL
select *
from signature s JOIN launchd d
ON d.program_arguments = s.path
WHERE d.path NOT LIKE '/System/Library/%'
      AND d.name like 'com.apple.%' and signed=1
      AND authority!='Software Signing' AND d.run_at_load=1;",
```

### Detect by profiling LaunchAgents/LaunchDaemons in your environment
In smaller environments, you may be able to find anomalous autoruns just by looking for rare autoruns across all your machines.

### Detect using process data with the submitted_by_plist field and the code signature

Some EDRs will give you a process record with a `submitted_by_plist` field and a code signature field. The `submitted_by_plist` field tells you which LaunchAgent or LaunchDaemon asked launchd to load that executable.

Some sample values of the `submitted_by_plist` field
```
/system/library/launchdaemons/com.apple.atrun.plist
/system/library/launchagents/com.apple.mdworker.shared.plist
```

You can use these two fields together to search for unsigned executables launched because of a plist file. This is a sample query, your SIEM might have different fields.
```
event.name:"process"
EXISTS(subject.process_information.submitted_by_plist)
NOT (
  EXISTS(code_signature.signing_id)
  || EXISTS(code_signature.team_id)
)
```

## Adding the executable bit with chmod

Ocean Lotus, like other malware, uses `chmod +x` or `chmod 755` to add the executable bit to malicious binaries.

Samples of commands
```
chmod +x /Users/loonicorn/Library/WebKit/osx.download
chmod 755 /Users/loonicorn/Library/WebKit/com.apple.launchpad
```

### Detect using process execution data

Any tool that collects process telemetry will catch `chmod +x` or `chmod 755` commands. Unfortunately, there is a lot of background noise for this activity. [Normalized Baseline Detection](https://github.com/megancarney/nbd/) is one strategy for filtering out the noise.

## Backdating using the touch command

Ocean Lotus uses `touch -t` to backdate files. Making files appear as if they are older than they are throws off incident response timeline analysis.

Samples of commands
```
touch -t 1910071234 ~/Library/LaunchAgents/com.apple.launchpad.plist
touch -t 1910071234 ~/Library/WebKit/b2NlYW5sb3R1czIz
touch -t 1910071234 ~/Library/WebKit/com.apple.launchpad
```

### Detect using process execution data

Any tool that collects process telemetry will catch `touch -e` commands. Unfortunately, some legitimate compiler and developer tools use this command as well. [Normalized Baseline Detection](https://github.com/megancarney/nbd/) is one strategy for filtering out the noise.

## Removing the quarantine attribute with xattr

Ocean Lotus, like other malware, uses the `xattr` to remove the quarantine attribute and bypass Gatekeeper.

Samples of commands
```
find /private/tmp/conkylan.app/Contents/MacOS -exec xattr -d com.apple.quarantine {} +
xattr -d com.apple.quarantine /private/tmp/conkylan.app/Contents/MacOS /private/tmp/conkylan.app/Contents/MacOS/conkylan
```

The first command recursively removes the quarantine attribute from any files inside `/private/tmp/conkylan.app/Contents/MacOS`. The second command is actually the result of running the first.

### Detect xattr -d using process execution data

Any tool that collects process telemetry will catch `xattr -d` commands. Unfortunately, benign installers use this technique as well. [Normalized Baseline Detection](https://github.com/megancarney/nbd/) is one strategy for filtering out the noise.

### Detect find/xattr using process execution data

Using find to recursively remove the quarantine attribute is rare. A sample query:
```
event.name:"process" 
process.args:("*find" && "-exec" && "*xattr" && "com.apple.quarantine")
```

