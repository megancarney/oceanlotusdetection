# OceanLotus Detection

Featured in "Dropping Lotus Bombs: ATT&CK in macOS Purple Team Operations" #OBTSv6. Slides posted in the [NBD repo](https://github.com/megancarney/nbd) and at [my website](https://www.megancarney.com/speaking.html).

## Executables in user directories loading modules into memory

Ocean Lotus uses different modules to load different functions. Loading those modules generates `ES_EVENT_TYPE_NOTIFY_MMAP` Endpoint Security Framework (ESF) events. In the Ocean Lotus emulation, the executable was dropped into `~/Library/Webkit/com.apple.launchpad`.

Loading modules is typically done by applications, and most applications don't live in `~/Library/`.

### Detect using ES_EVENT_TYPE_NOTIFY_MMAP events

Look for `ES_EVENT_TYPE_NOTIFY_MMAP` events generated by executables living in user home directories. This will be noisy without some filtering. There are some legitimate applications that put executables in `~/Library/`

## Unsigned LaunchAgents/LaunchDaemons

OceanLotus persists using a LaunchAgent that runs an unsigned executable.

### Detect using osquery launchd and signature tables

You can write a SQL query that will join the `launchd` and `signature` tables on the `program` or `program_arguments` fields. One caveat - this method fails when the `program` or `program_arguments` field contains an executable with command-line arguments. In those cases, the join on the signature table will fail.

For a more sophisticated version of this, you can use python. Use the `launchd` table to pull executable names and then python to parse out all the executables, then check the signing status using the `signature` table in osquery.

### Detect by looking for misleading bundle identifiers

In this emulation, Ocean Lotus' LaunchAgent had a bundle id of `com.apple.launchpad` but the executable run in the LaunchAgent was not signed by apple.

We can use the launchd and signature tables in osquery to find these cases. False negatives here are a possibility if the `program_argument` field doesn't match a filename in the `signature` table. In those cases, the join on the signature table will fail. As with the example above, you could script a solution using python to get around this issue.

```
# Osquery SQL
select *
from signature s JOIN launchd d
ON d.program_arguments = s.path
WHERE d.path NOT LIKE '/System/Library/%'
      AND d.name like 'com.apple.%' and signed=1
      AND authority!='Software Signing' AND d.run_at_load=1;",
```

### Detect by profiling LaunchAgents/LaunchDaemons in your environment
In smaller environments, you may be able to find anomalous autoruns just by looking for rare autoruns across all your machines.

### Detect using process data with the submitted_by_plist field and the code signature

Some EDRs will give you a process record with a `submitted_by_plist` field and a code signature field. The `submitted_by_plist` field tells you which LaunchAgent or LaunchDaemon asked launchd to load that executable.

Some sample values of the `submitted_by_plist` field
```
/system/library/launchdaemons/com.apple.atrun.plist
/system/library/launchagents/com.apple.mdworker.shared.plist
```

You can use these two fields together to search for unsigned executables launched because of a plist file. This is a sample query, your SIEM might have different fields.
```
event.name:"process"
EXISTS(subject.process_information.submitted_by_plist)
NOT (
  EXISTS(code_signature.signing_id)
  || EXISTS(code_signature.team_id)
)
```

## Adding the executable bit with chmod

Ocean Lotus, like other malware, uses `chmod +x` or `chmod 755` to add the executable bit to malicious binaries.

Samples of commands
```
chmod +x /Users/loonicorn/Library/WebKit/osx.download
chmod 755 /Users/loonicorn/Library/WebKit/com.apple.launchpad
```

### Detect using process execution data

Any tool that collects process telemetry will catch `chmod +x` or `chmod 755` commands. Unfortunately, there is a lot of background noise for this activity. [Normalized Baseline Detection](https://github.com/megancarney/nbd/) is one strategy for filtering out the noise.

## Backdating using the touch command

Ocean Lotus uses `touch -t` to backdate files. Making files appear as if they are older than they are throws off incident response timeline analysis.

Samples of commands
```
touch -t 1910071234 ~/Library/LaunchAgents/com.apple.launchpad.plist
touch -t 1910071234 ~/Library/WebKit/b2NlYW5sb3R1czIz
touch -t 1910071234 ~/Library/WebKit/com.apple.launchpad
```

### Detect using process execution data

Any tool that collects process telemetry will catch `touch -t` commands. Unfortunately, some legitimate compiler and developer tools use this command as well. [Normalized Baseline Detection](https://github.com/megancarney/nbd/) is one strategy for filtering out the noise.

## Removing the quarantine attribute with xattr

Ocean Lotus, like other malware, uses the `xattr` to remove the quarantine attribute and bypass Gatekeeper.

Samples of commands
```
find /private/tmp/conkylan.app/Contents/MacOS -exec xattr -d com.apple.quarantine {} +
xattr -d com.apple.quarantine /private/tmp/conkylan.app/Contents/MacOS /private/tmp/conkylan.app/Contents/MacOS/conkylan
```

The first command recursively removes the quarantine attribute from any files inside `/private/tmp/conkylan.app/Contents/MacOS`. The second command is actually the result of running the first.

### Detect xattr -d using process execution data

Any tool that collects process telemetry will catch `xattr -d` commands. Unfortunately, benign installers use this technique as well. [Normalized Baseline Detection](https://github.com/megancarney/nbd/) is one strategy for filtering out the noise.

### Detect find/xattr using process execution data

Using find to recursively remove the quarantine attribute is rare. A sample query:
```
event.name:"process" 
process.args:("*find" && "-exec" && "*xattr" && "com.apple.quarantine")
```

## Gathering system data with sed/awk and recon commands

The OceanLotus emulation uses `sed`/`awk` with recon commands like `system_profiler` or `klist` to gather information and profile a system. Gathering information on hardware and installed software is a common tactic for threat actors. Each `sh -c` process results in a second process with the command passed to `sh -c`. We can target detection at either the `sh -c` commands or the recon commands themselves.
```
sh -c ifconfig en0 | awk &apos;/ether/{print $2}&apos;
awk /ether/{print $2}

sh -c klist 2&gt;/dev/null | awk &apos;/Principal/ {split($0,line,&quot;@&quot;); printf(&quot;%s&quot;, line[2])}&apos;
awk /Principal/ {split($0,line,&quot;@&quot;); printf(&quot;%s&quot;, line[2])}

sh -c system_profiler SPHardwareDataType 2&gt;/dev/null | awk &apos;/Memory/ {split($0,line, &quot;: &quot;); printf(&quot;%s&quot;, line[2]);}&apos;
awk /Memory/ {split($0,line, &quot;: &quot;); printf(&quot;%s&quot;, line[2]);}

sh -c system_profiler SPHardwareDataType 2&gt;/dev/null | awk &apos;/Processor / {split($0,line,&quot;: &quot;); printf(&quot;%s&quot;,line[2]);}&apos;
awk /Processor / {split($0,line,&quot;: &quot;); printf(&quot;%s&quot;,line[2]);}

sh -c system_profiler SPHardwareDataType 2&gt;/dev/null | awk &apos;/Processor Name/ {split($0,line, &quot;: &quot;); printf(&quot;%s&quot;, line[2]);}&apos;
awk /Processor Name/ {split($0,line, &quot;: &quot;); printf(&quot;%s&quot;, line[2]);}

sh -c klist 2>/dev/null | awk '/Principal/ {split($0,line,"@"); printf("%s", line[2])}'
awk /Principal/ {split($0,line,"@"); printf("%s", line[2])}

sh -c system_profiler SPHardwareDataType 2>/dev/null | awk '/Memory/ {split($0,line, ": "); printf("%s", line[2]);}'
awk /Memory/ {split($0,line, &quot;: &quot;); printf(&quot;%s&quot;, line[2]);}

sh -c system_profiler SPHardwareDataType 2>/dev/null | awk '/Processor / {split($0,line,": "); printf("%s",line[2]);}'
awk /Processor / {split($0,line,": "); printf("%s",line[2]);}

sh -c system_profiler SPHardwareDataType 2>/dev/null | awk '/Processor Name/ {split($0,line, ": "); printf("%s", line[2]);}'
awk /Processor Name/ {split($0,line, ": "); printf("%s", line[2]);}

/bin/sh -c /System/Library/PrivateFrameworks/Apple80211.framework/Versions/Current/Resources/airport -I | awk &apos;/ SSID/ {print substr($0, index($0, $2))}&apos;
awk / SSID/ {print substr($0, index($0, $2))}
```

### Detect using process execution data

All of these commands will appear in process execution data. However, legitimate software packages also use these commands when installing. [Normalized Baseline Detection](https://github.com/megancarney/nbd/) is one strategy for filtering out the noise. Other strategies include counting recon commands run per responsible process and only alerting if a responsible process has run multiple recon commmands.

## Encoding/decoding with openssl and base64

OceanLotus, like other malware, uses `openssl` and `base64` to decode commands sent to the machine and encode data sent from the host.
```
/bin/sh - /usr/bin/base64
/bin/sh - /usr/bin/base64 -d
openssl enc -base64
sh -c echo <UUID><MAC_ADDRESS> | md5 | xxd -r -p | base64
openssl enc -base64 -d
```

### Detect using process execution data

All of these commands will appear in process execution data. Unfortunately, legitimate developer tools also use these commands to encode/decode data. [Normalized Baseline Detection](https://github.com/megancarney/nbd/) is one strategy for filtering out the noise.

## Accessing shell history

After compromising the host, OceanLotus accesses shell history files.
```
cat /Users/loonicorn/.bash_history
cat /Users/loonicorn/.zsh_history
```

### Detect using process execution data

These commands will appear in process execution data. You may have a few applications to filter out, but the background noise is more manageable.
```
event.name:"process"
process.name:"cat"
process.args:("*history") 
```
